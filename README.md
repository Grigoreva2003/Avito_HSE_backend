# Backend Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°
ÐšÑƒÑ€Ñ Ð¿Ð¾ Backend'Ñƒ Ð¾Ñ‚ Ð¼Ð°Ð³Ð¸ÑÑ‚ÐµÑ€ÑÐºÐ¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ÐÐ˜Ð£ Ð’Ð¨Ð­ Ð² ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ðµ Ñ ÐÐ²Ð¸Ñ‚Ð¾

## ÐÐ²Ñ‚Ð¾Ñ€
Ð“Ñ€Ð¸Ð³Ð¾Ñ€ÑŒÐµÐ²Ð° Ð’Ð°ÑÐ¸Ð»Ð¸ÑÐ°, ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚ÐºÐ° Ð¼Ð°Ð³Ð¸ÑÑ‚Ñ€Ð°Ñ‚ÑƒÑ€Ñ‹ ÐÐ˜Ð£ Ð’Ð¨Ð­ Ð¤ÐšÐ Ñ… ÐÐ²Ð¸Ñ‚Ð¾ "ÐœÐ°ÑˆÐ¸Ð½Ð½Ð¾Ðµ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð² Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ð¾Ð¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ðµ"

## ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
Ð¡ÐµÑ€Ð²Ð¸Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹ Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ ML-Ð¼Ð¾Ð´ÐµÐ»Ð¸ (LogisticRegression) Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ð¹. 

## Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ð¾ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°Ð¼

- Ð¢ÐµÑÑ‚Ñ‹ Ð¸ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°: [`tests/README.md`](tests/README.md)
- ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°, retry, DLQ: [`app/workers/README.md`](app/workers/README.md)
- ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¸ ÑÑ…ÐµÐ¼Ð° Ð‘Ð”: [`db/README.md`](db/README.md)

### ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°
ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¿Ð¾ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ñƒ **Ð¼Ð½Ð¾Ð³Ð¾ÑÐ»Ð¾Ð¹Ð½Ð¾Ð¹ Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ½Ð¾Ð¹ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹**:

- **HTTP Layer** (routers/) - Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° HTTP Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ, Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
- **Service Layer** (services/) - Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
- **ML Layer** (ml/) - Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒÑŽ
- **Message Queue** (Kafka/Redpanda) - Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
- **Workers** (app/workers/) - Ñ„Ð¾Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð·Ð°Ð´Ð°Ñ‡ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
- **Data Layer** (repositories/) - Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ PostgreSQL
- **Dead Letter Queue** - Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸ retry Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
```
â”œâ”€â”€ main.py                         # Ð¢Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° FastAPI
â”œâ”€â”€ config.py                       # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
â”œâ”€â”€ database.py                     # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº PostgreSQL
â”œâ”€â”€ docker-compose.yml              # PostgreSQL + Redis + Redpanda + Console
â”œâ”€â”€ pytest.ini                      # ÐœÐ°Ñ€ÐºÐµÑ€Ñ‹ Ñ‚ÐµÑÑ‚Ð¾Ð² (integration)
â”œâ”€â”€ ml/                             # ML ÑÐ»Ð¾Ð¹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ model_manager.py            # ModelManager - Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒÑŽ
â”œâ”€â”€ models/                         # Pydantic Ð¼Ð¾Ð´ÐµÐ»Ð¸
â”‚   â””â”€â”€ ads.py                      # ÐœÐ¾Ð´ÐµÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²/Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
â”œâ”€â”€ routers/                        # HTTP ÑÐ»Ð¾Ð¹
â”‚   â””â”€â”€ ads.py                      # Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹ API
â”œâ”€â”€ services/                       # Ð‘Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ°
â”‚   â”œâ”€â”€ exceptions.py               # Ð”Ð¾Ð¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
â”‚   â”œâ”€â”€ moderation.py               # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ
â”‚   â””â”€â”€ async_moderation.py         # ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ
â”œâ”€â”€ repositories/                   # Data Access Layer
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ sellers.py                  # CRUD Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð¾Ð²
â”‚   â”œâ”€â”€ ads.py                      # CRUD Ð´Ð»Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹
â”‚   â”œâ”€â”€ moderation_results.py       # CRUD Ð´Ð»Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
â”‚   â””â”€â”€ prediction_cache.py         # ÐšÑÑˆ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ð¹ (Redis)
â”œâ”€â”€ app/                            # ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ Ð¸ Ð²Ð¾Ñ€ÐºÐµÑ€Ñ‹
â”‚   â”œâ”€â”€ clients/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ kafka.py                # Kafka Producer
â”‚   â”‚   â””â”€â”€ redis.py                # Redis client
â”‚   â””â”€â”€ workers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ moderation_worker.py    # Kafka Consumer (Ð²Ð¾Ñ€ÐºÐµÑ€)
â”‚       â””â”€â”€ dlq_monitor.py          # DLQ Monitor
â”œâ”€â”€ db/                             # SQL Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ V001__initial_schema.sql
â”‚   â”‚   â”œâ”€â”€ V002__seed_data.sql
â”‚   â”‚   â”œâ”€â”€ V003__moderation_results.sql
â”‚   â”‚   â””â”€â”€ V004__add_is_closed_to_ads.sql
â”‚   â”œâ”€â”€ README.md
â”‚   â””â”€â”€ migrations.yml
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py                 # ÐžÐ±Ñ‰Ð¸Ðµ Ñ„Ð¸ÐºÑÑ‚ÑƒÑ€Ñ‹
â”‚   â”œâ”€â”€ unit/                       # API Ð¸ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ° (Ñ Ð¼Ð¾ÐºÐ°Ð¼Ð¸)
â”‚   â””â”€â”€ integration/                # Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
â”‚       â”œâ”€â”€ postgresql/             # Ð¢ÐµÑÑ‚Ñ‹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² PostgreSQL
â”‚       â””â”€â”€ test_prediction_cache_integration.py
â””â”€â”€ requirements.txt                # Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python
```

## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº

### 1. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
```bash
python3 -m venv venv
source venv/bin/activate  # Ð´Ð»Ñ macOS/Linux
```

### 2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ PostgreSQL

```bash
# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ PostgreSQL 15 (macOS)
brew install postgresql@15

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²Ð¸Ñ PostgreSQL
brew services start postgresql@15

# Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ PostgreSQL Ð² PATH
export PATH="/opt/homebrew/opt/postgresql@15/bin:$PATH"
```

### 3. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ð² ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cat > .env << 'EOF'
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=
DB_DATABASE=avito_moderation
DB_POOL_MIN_SIZE=10
DB_POOL_MAX_SIZE=20

APP_NAME=Avito Moderation Service
APP_VERSION=1.0.0
APP_HOST=0.0.0.0
APP_PORT=8003
APP_DEBUG=False
APP_LOG_LEVEL=INFO

ML_MODEL_PATH=model.pkl
ML_MODEL_VERSION=1.0.0
EOF
```

**Ð’Ð°Ð¶Ð½Ð¾:** 
- Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ `DB_USER=postgres` Ð½Ð° Ð²Ð°ÑˆÐµ Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ `whoami` Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ)
- Ð”Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð½Ð° macOS Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ `DB_PASSWORD=` Ð¿ÑƒÑÑ‚Ñ‹Ð¼)
- Ð”Ð»Ñ production ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
- Ð¤Ð°Ð¹Ð» `.env` Ð½Ðµ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ð² git


### 4. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python

```bash
pip install -r requirements.txt
```

### 5. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð² Docker (PostgreSQL + Redis + Kafka)

```bash
# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
docker-compose up -d

# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ
docker-compose ps
```

**Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹:**
- PostgreSQL: `localhost:5432`
- Redis: `localhost:6379`
- Kafka (Redpanda): `localhost:9092`
- Web Console: http://localhost:8080

Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Redis (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÑÑˆÐ°):
```bash
docker-compose up -d redis
```

### 6. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ

```bash
python3.11 main.py
```

Ð¡ÐµÑ€Ð²Ð¸Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: `http://localhost:8003`

ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ:
- Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº PostgreSQL
- **ModelManager** Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ
- ÐžÐ±ÑƒÑ‡Ð°ÐµÑ‚ÑÑ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½Ð° ÑÐ¸Ð½Ñ‚ÐµÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- ÐœÐ¾Ð´ÐµÐ»ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð² `model.pkl`
- **Kafka Producer** Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ðº Redpanda
- ÐŸÑ€Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ… Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°

### 7. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð²Ð¾Ñ€ÐºÐµÑ€ Ð´Ð»Ñ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)

```bash
# Ð’ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ
python3.11 -m app.workers.moderation_worker
```

Ð’Ð¾Ñ€ÐºÐµÑ€ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð· Kafka Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸.

## ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ðŸ”§

Ð’ÑÐµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð½ÐµÑÐµÐ½Ñ‹ Ð² Ñ„Ð°Ð¹Ð» `.env` Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· `config.py` Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ **Pydantic Settings**.

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸

| Ð“Ñ€ÑƒÐ¿Ð¿Ð°           | ÐŸÑ€ÐµÑ„Ð¸ÐºÑ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ                                    |
|------------------|---------|---------------------------------------------|
| DatabaseSettings | `DB_*`  | ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº PostgreSQL          |
| AppSettings      | `APP_*` | ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (Ð¿Ð¾Ñ€Ñ‚, Ñ…Ð¾ÑÑ‚, Ð»Ð¾Ð³Ð¸)     |
| MLSettings       | `ML_*`  | ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ML-Ð¼Ð¾Ð´ÐµÐ»Ð¸ (Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ Ð¼Ð¾Ð´ÐµÐ»Ð¸)   |

**ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ macOS:** PostgreSQL Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¸Ð¼Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹. Ð£Ð·Ð½Ð°Ð¹Ñ‚Ðµ ÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ `whoami` Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð² `DB_USER`. ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ `DB_PASSWORD` Ð¿ÑƒÑÑ‚Ñ‹Ð¼).

### ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² ÐºÐ¾Ð´Ðµ

```python
from config import get_settings

settings = get_settings()

# Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼ Ð‘Ð”
print(settings.database.host)          # localhost
print(settings.database.url)           # postgresql://user:pass@host:port/db
print(settings.database.async_url)     # postgresql+asyncpg://...

# Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
print(settings.app.port)               # 8003
print(settings.app.log_level)          # INFO
print(settings.app.debug)              # False

# Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼ Ð¼Ð¾Ð´ÐµÐ»Ð¸
print(settings.ml.model_path)          # model.pkl
```
## Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…

ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ð¾ ÑÑ…ÐµÐ¼Ðµ, Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÐ¼, Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸ÑŽ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
Ð²Ñ‹Ð½ÐµÑÐµÐ½Ð° Ð² [`db/README.md`](db/README.md).

### Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸

Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð‘Ð” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸:

- **SellerRepository** (`repositories/sellers.py`) - CRUD Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð¾Ð²
- **AdRepository** (`repositories/ads.py`) - CRUD Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹

ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ:

```python
from repositories import SellerRepository, AdRepository

# ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð°
seller_repo = SellerRepository()
seller = await seller_repo.get_by_id(1)

# ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
ad_repo = AdRepository()
ad = await ad_repo.get_by_id(100, include_seller=True)
print(ad.seller_is_verified)  # True
```

## API

### Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ðµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹

#### POST /predict
Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ð¹ (Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸).

**Ð—Ð°Ð¿Ñ€Ð¾Ñ:**
```json
{
  "seller_id": 1,
  "is_verified_seller": true,
  "item_id": 100,
  "name": "ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°",
  "description": "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°",
  "category": 5,
  "images_qty": 3
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (200 OK):**
```json
{
  "is_violation": false,
  "probability": 0.12
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ
- `422` - ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- `503` - ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°

#### POST /simple_predict
Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ item_id, Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÐµÑ€ÑƒÑ‚ÑÑ Ð¸Ð· Ð‘Ð”).

**Ð—Ð°Ð¿Ñ€Ð¾Ñ:**
```json
{
  "item_id": 100
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (200 OK):**
```json
{
  "is_violation": false,
  "probability": 0.12
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ
- `404` - ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
- `422` - ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- `503` - ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°

### ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ðµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹ (Ñ‡ÐµÑ€ÐµÐ· Kafka)

#### POST /async_predict
ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð½Ð° Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸ÑŽ.

**Ð—Ð°Ð¿Ñ€Ð¾Ñ:**
```json
{
  "item_id": 100
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (200 OK):**
```json
{
  "task_id": 1,
  "status": "pending",
  "message": "Moderation request accepted"
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð—Ð°Ð´Ð°Ñ‡Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°
- `404` - ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
- `422` - ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°

#### POST /close
Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ `item_id`.

ÐœÐµÑ‚Ð¾Ð´ ÑƒÐ´Ð°Ð»ÑÐµÑ‚:
- Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· PostgreSQL,
- ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ `moderation_results` Ð¸Ð· PostgreSQL,
- ÐºÑÑˆ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ Ð¿Ð¾ `item_id` Ð¸ ÐºÑÑˆ async-Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ð¾ `task_id` Ð¸Ð· Redis.

**Ð—Ð°Ð¿Ñ€Ð¾Ñ:**
```json
{
  "item_id": 100
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (200 OK):**
```json
{
  "item_id": 100,
  "status": "closed",
  "message": "Ad successfully closed"
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾
- `404` - ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
- `422` - ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°

#### GET /moderation_result/{task_id}
ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð¹ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ (polling).

**ÐžÑ‚Ð²ÐµÑ‚ (pending):**
```json
{
  "task_id": 1,
  "status": "pending",
  "is_violation": null,
  "probability": null
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (completed):**
```json
{
  "task_id": 1,
  "status": "completed",
  "is_violation": false,
  "probability": 0.23
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (failed):**
```json
{
  "task_id": 1,
  "status": "failed",
  "is_violation": null,
  "probability": null,
  "error_message": "ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°"
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½
- `404` - Ð—Ð°Ð´Ð°Ñ‡Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°

## ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð²Ñ‹Ð½ÐµÑÐµÐ½Ð° Ð² ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:

- Ð’Ð¾Ñ€ÐºÐµÑ€Ñ‹, retry Ð¸ DLQ: [`app/workers/README.md`](app/workers/README.md)
- Ð—Ð°Ð¿ÑƒÑÐº Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²: [`tests/README.md`](tests/README.md)

## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

### Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ

```bash
# ÐŸÐ¾Ð»Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
curl -X POST http://localhost:8003/predict \
  -H "Content-Type: application/json" \
  -d '{
    "seller_id": 1,
    "is_verified_seller": true,
    "item_id": 100,
    "name": "iPhone 15",
    "description": "ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½",
    "category": 1,
    "images_qty": 5
  }'

# Ð¢Ð¾Ð»ÑŒÐºÐ¾ item_id
curl -X POST http://localhost:8003/simple_predict \
  -H "Content-Type: application/json" \
  -d '{"item_id": 100}'
```

### ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ

```bash
# 1. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ
curl -X POST http://localhost:8003/async_predict \
  -H "Content-Type: application/json" \
  -d '{"item_id": 100}'

# ÐžÑ‚Ð²ÐµÑ‚: {"task_id": 1, "status": "pending", ...}

# 2. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ (polling)
curl http://localhost:8003/moderation_result/1

# ÐŸÐ¾ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ: {"status": "pending", ...}
# ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸: {"status": "completed", "is_violation": false, ...}
```

## ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ°

Ð Ð°Ð·Ð´ÐµÐ» Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Kafka/DLQ Ð¸ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ð²Ñ‹Ð½ÐµÑÐµÐ½Ñ‹ Ð²:
[`app/workers/README.md`](app/workers/README.md)
