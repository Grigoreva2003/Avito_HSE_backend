# Backend Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°
ÐšÑƒÑ€Ñ Ð¿Ð¾ Backend'Ñƒ Ð¾Ñ‚ Ð¼Ð°Ð³Ð¸ÑÑ‚ÐµÑ€ÑÐºÐ¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ÐÐ˜Ð£ Ð’Ð¨Ð­ Ð² ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ðµ Ñ ÐÐ²Ð¸Ñ‚Ð¾

## ÐÐ²Ñ‚Ð¾Ñ€
Ð“Ñ€Ð¸Ð³Ð¾Ñ€ÑŒÐµÐ²Ð° Ð’Ð°ÑÐ¸Ð»Ð¸ÑÐ°, ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚ÐºÐ° Ð¼Ð°Ð³Ð¸ÑÑ‚Ñ€Ð°Ñ‚ÑƒÑ€Ñ‹ ÐÐ˜Ð£ Ð’Ð¨Ð­ Ð¤ÐšÐ Ñ… ÐÐ²Ð¸Ñ‚Ð¾ "ÐœÐ°ÑˆÐ¸Ð½Ð½Ð¾Ðµ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð² Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ð¾Ð¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ðµ"

## ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
Ð¡ÐµÑ€Ð²Ð¸Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹ Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ ML-Ð¼Ð¾Ð´ÐµÐ»Ð¸ (LogisticRegression) Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ð¹. 

### ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°
ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¿Ð¾ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ñƒ **Ð¼Ð½Ð¾Ð³Ð¾ÑÐ»Ð¾Ð¹Ð½Ð¾Ð¹ Ð¼Ð¸ÐºÑ€Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ½Ð¾Ð¹ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹**:

- **HTTP Layer** (routers/) - Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° HTTP Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ, Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
- **Service Layer** (services/) - Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
- **ML Layer** (ml/) - Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒÑŽ
- **Message Queue** (Kafka/Redpanda) - Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
- **Workers** (app/workers/) - Ñ„Ð¾Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð·Ð°Ð´Ð°Ñ‡ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
- **Data Layer** (repositories/) - Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ PostgreSQL
- **Dead Letter Queue** - Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸ retry Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
```
â”œâ”€â”€ main.py                         # Ð¢Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° FastAPI
â”œâ”€â”€ config.py                       # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
â”œâ”€â”€ database.py                     # ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº PostgreSQL
â”œâ”€â”€ docker-compose.yml              # Redpanda (Kafka) + Console
â”œâ”€â”€ ml/                             # ML ÑÐ»Ð¾Ð¹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ model_manager.py            # ModelManager - Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒÑŽ
â”œâ”€â”€ models/                         # Pydantic Ð¼Ð¾Ð´ÐµÐ»Ð¸
â”‚   â””â”€â”€ ads.py                      # ÐœÐ¾Ð´ÐµÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²/Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
â”œâ”€â”€ routers/                        # HTTP ÑÐ»Ð¾Ð¹
â”‚   â””â”€â”€ ads.py                      # Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹ API
â”œâ”€â”€ services/                       # Ð‘Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ°
â”‚   â”œâ”€â”€ exceptions.py               # Ð”Ð¾Ð¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
â”‚   â”œâ”€â”€ moderation.py               # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ
â”‚   â””â”€â”€ async_moderation.py         # ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ
â”œâ”€â”€ repositories/                   # Data Access Layer
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ sellers.py                  # CRUD Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð¾Ð²
â”‚   â”œâ”€â”€ ads.py                      # CRUD Ð´Ð»Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹
â”‚   â””â”€â”€ moderation_results.py       # CRUD Ð´Ð»Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
â”œâ”€â”€ app/                            # Kafka Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ
â”‚   â”œâ”€â”€ clients/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ kafka.py                # Kafka Producer
â”‚   â””â”€â”€ workers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ moderation_worker.py    # Kafka Consumer (Ð²Ð¾Ñ€ÐºÐµÑ€)
â”‚       â””â”€â”€ dlq_monitor.py          # DLQ Monitor
â”œâ”€â”€ db/                             # SQL Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ V001__initial_schema.sql
â”‚   â”œâ”€â”€ V002__seed_data.sql
â”‚   â”œâ”€â”€ V003__moderation_results.sql
â”‚   â””â”€â”€ migrations.yml
â”œâ”€â”€ tests/                          # Unit-Ñ‚ÐµÑÑ‚Ñ‹
â”‚   â”œâ”€â”€ conftest.py                 # ÐžÐ±Ñ‰Ð¸Ðµ Ñ„Ð¸ÐºÑÑ‚ÑƒÑ€Ñ‹
â”‚   â””â”€â”€ test_ads.py                 # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ /predict
â””â”€â”€ requirements.txt                # Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python
```

## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº

### 1. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
```bash
python3 -m venv venv
source venv/bin/activate  # Ð´Ð»Ñ macOS/Linux
```

### 2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ PostgreSQL

```bash
# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ PostgreSQL 15 (macOS)
brew install postgresql@15

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²Ð¸Ñ PostgreSQL
brew services start postgresql@15

# Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ PostgreSQL Ð² PATH
export PATH="/opt/homebrew/opt/postgresql@15/bin:$PATH"
```

### 3. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ð² ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cat > .env << 'EOF'
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=
DB_DATABASE=avito_moderation
DB_POOL_MIN_SIZE=10
DB_POOL_MAX_SIZE=20

APP_NAME=Avito Moderation Service
APP_VERSION=1.0.0
APP_HOST=0.0.0.0
APP_PORT=8003
APP_DEBUG=False
APP_LOG_LEVEL=INFO

ML_MODEL_PATH=model.pkl
ML_MODEL_VERSION=1.0.0
EOF
```

**Ð’Ð°Ð¶Ð½Ð¾:** 
- Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ `DB_USER=postgres` Ð½Ð° Ð²Ð°ÑˆÐµ Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ `whoami` Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ)
- Ð”Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð½Ð° macOS Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ `DB_PASSWORD=` Ð¿ÑƒÑÑ‚Ñ‹Ð¼)
- Ð”Ð»Ñ production ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
- Ð¤Ð°Ð¹Ð» `.env` Ð½Ðµ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ð² git


### 4. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python

```bash
pip install -r requirements.txt
```

### 5. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Docker Ñ Redpanda (Kafka)

```bash
# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Redpanda Ð¸ Console
docker-compose up -d

# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ
docker-compose ps
```

**Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹:**
- Kafka (Redpanda): `localhost:9092`
- Web Console: http://localhost:8080

### 6. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ

```bash
python3.11 main.py
```

Ð¡ÐµÑ€Ð²Ð¸Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: `http://localhost:8003`

ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ:
- Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº PostgreSQL
- **ModelManager** Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ
- ÐžÐ±ÑƒÑ‡Ð°ÐµÑ‚ÑÑ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½Ð° ÑÐ¸Ð½Ñ‚ÐµÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- ÐœÐ¾Ð´ÐµÐ»ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð² `model.pkl`
- **Kafka Producer** Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ðº Redpanda
- ÐŸÑ€Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ… Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°

### 7. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð²Ð¾Ñ€ÐºÐµÑ€ Ð´Ð»Ñ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)

```bash
# Ð’ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ
python3.11 -m app.workers.moderation_worker
```

Ð’Ð¾Ñ€ÐºÐµÑ€ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð· Kafka Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸.

## ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ðŸ”§

Ð’ÑÐµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð½ÐµÑÐµÐ½Ñ‹ Ð² Ñ„Ð°Ð¹Ð» `.env` Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· `config.py` Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ **Pydantic Settings**.

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸

| Ð“Ñ€ÑƒÐ¿Ð¿Ð°           | ÐŸÑ€ÐµÑ„Ð¸ÐºÑ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ                                    |
|------------------|---------|---------------------------------------------|
| DatabaseSettings | `DB_*`  | ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº PostgreSQL          |
| AppSettings      | `APP_*` | ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (Ð¿Ð¾Ñ€Ñ‚, Ñ…Ð¾ÑÑ‚, Ð»Ð¾Ð³Ð¸)     |
| MLSettings       | `ML_*`  | ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ML-Ð¼Ð¾Ð´ÐµÐ»Ð¸ (Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ Ð¼Ð¾Ð´ÐµÐ»Ð¸)   |

**ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ macOS:** PostgreSQL Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¸Ð¼Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹. Ð£Ð·Ð½Ð°Ð¹Ñ‚Ðµ ÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ `whoami` Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð² `DB_USER`. ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ `DB_PASSWORD` Ð¿ÑƒÑÑ‚Ñ‹Ð¼).

### ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² ÐºÐ¾Ð´Ðµ

```python
from config import get_settings

settings = get_settings()

# Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼ Ð‘Ð”
print(settings.database.host)          # localhost
print(settings.database.url)           # postgresql://user:pass@host:port/db
print(settings.database.async_url)     # postgresql+asyncpg://...

# Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
print(settings.app.port)               # 8003
print(settings.app.log_level)          # INFO
print(settings.app.debug)              # False

# Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼ Ð¼Ð¾Ð´ÐµÐ»Ð¸
print(settings.ml.model_path)          # model.pkl
```
## Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…

### Ð¡Ñ…ÐµÐ¼Ð° Ð‘Ð”

ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ PostgreSQL Ñ Ð´Ð²ÑƒÐ¼Ñ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼Ð¸:

- **sellers** (Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ñ‹/Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸) - Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð°Ñ…
- **ads** (Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ) - Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸ÑÑ…

Ð¡Ð²ÑÐ·ÑŒ: `ads.seller_id` â†’ `sellers.id` (Ð¾Ð´Ð¸Ð½ Ð¿Ñ€Ð¾Ð´Ð°Ð²ÐµÑ† Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð¼ÐµÑ‚ÑŒ Ð¼Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹)

### Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð‘Ð” Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
createdb avito_moderation

# ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ‡ÐµÑ€ÐµÐ· pgmigrate
cd db
pgmigrate -t latest migrate
cd ..

# Ð˜Ð»Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· psql
psql avito_moderation -f db/V001__initial_schema.sql
psql avito_moderation -f db/V002__seed_data.sql

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‡Ñ‚Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹
psql avito_moderation -c "\dt"
psql avito_moderation -c "SELECT COUNT(*) FROM sellers;"
psql avito_moderation -c "SELECT COUNT(*) FROM ads;"
```

**Ð’Ð°Ð¶Ð½Ð¾:** Ð•ÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ (Ñ…Ð¾ÑÑ‚, Ð¿Ð¾Ñ€Ñ‚, Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ), Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð¸Ñ… Ð² `db/migrations.yml`.

**ÐŸÐ¾ÑÑÐ½ÐµÐ½Ð¸Ðµ:**
- `envsubst < migrations.yml` - Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ `${DB_HOST}`, `${DB_PORT}` Ð¸ Ñ‚.Ð´. Ð¸Ð· Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
- `pgmigrate -c /dev/stdin` - Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð¸Ð· stdin (ÑƒÐ¶Ðµ Ñ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸)

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹
psql avito_moderation -c "\dt"

# ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†
psql avito_moderation -c "\d sellers"
psql avito_moderation -c "\d ads"

# ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
psql avito_moderation -c "SELECT * FROM sellers;"
psql avito_moderation -c "SELECT * FROM ads LIMIT 5;"
```

ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ Ð¾ ÑÑ…ÐµÐ¼Ðµ Ð‘Ð” Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÑ… ÑÐ¼. [`db/README.md`](db/README.md).

### Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸

Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð‘Ð” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸:

- **SellerRepository** (`repositories/sellers.py`) - CRUD Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð¾Ð²
- **AdRepository** (`repositories/ads.py`) - CRUD Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹

ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ:

```python
from repositories import SellerRepository, AdRepository

# ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð°
seller_repo = SellerRepository()
seller = await seller_repo.get_by_id(1)

# ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
ad_repo = AdRepository()
ad = await ad_repo.get_by_id(100, include_seller=True)
print(ad.seller_is_verified)  # True
```

## API

### Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ðµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹

#### POST /predict
Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ð¹ (Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸).

**Ð—Ð°Ð¿Ñ€Ð¾Ñ:**
```json
{
  "seller_id": 1,
  "is_verified_seller": true,
  "item_id": 100,
  "name": "ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°",
  "description": "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°",
  "category": 5,
  "images_qty": 3
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (200 OK):**
```json
{
  "is_violation": false,
  "probability": 0.12
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ
- `422` - ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- `503` - ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°

#### POST /simple_predict
Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ item_id, Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÐµÑ€ÑƒÑ‚ÑÑ Ð¸Ð· Ð‘Ð”).

**Ð—Ð°Ð¿Ñ€Ð¾Ñ:**
```json
{
  "item_id": 100
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (200 OK):**
```json
{
  "is_violation": false,
  "probability": 0.12
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ
- `404` - ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
- `422` - ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- `503` - ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°

### ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ðµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹ (Ñ‡ÐµÑ€ÐµÐ· Kafka)

#### POST /async_predict
ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð½Ð° Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸ÑŽ.

**Ð—Ð°Ð¿Ñ€Ð¾Ñ:**
```json
{
  "item_id": 100
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (202 Accepted):**
```json
{
  "task_id": 1,
  "status": "pending",
  "message": "Moderation request accepted"
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð—Ð°Ð´Ð°Ñ‡Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°
- `404` - ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
- `422` - ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°

#### GET /moderation_result/{task_id}
ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð¹ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ (polling).

**ÐžÑ‚Ð²ÐµÑ‚ (pending):**
```json
{
  "task_id": 1,
  "status": "pending",
  "is_violation": null,
  "probability": null
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (completed):**
```json
{
  "task_id": 1,
  "status": "completed",
  "is_violation": false,
  "probability": 0.23
}
```

**ÐžÑ‚Ð²ÐµÑ‚ (failed):**
```json
{
  "task_id": 1,
  "status": "failed",
  "is_violation": null,
  "probability": null,
  "error_message": "ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°"
}
```

**ÐšÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:**
- `200` - Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½
- `404` - Ð—Ð°Ð´Ð°Ñ‡Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°
- `500` - Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°

## ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Kafka

### ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  POST /async_predict  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Kafka Queue     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ FastAPI  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Worker     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                                      â”‚
    â†‘                                                                 â–¼
    â”‚                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                          â”‚ PostgreSQL   â”‚
    â”‚                                                          â”‚ + ML Model   â”‚
    â”‚                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                                                 â”‚
    â”‚                                                                 â–¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€ GET /moderation_result/{task_id} â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²

```bash
# Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 1: Docker (Redpanda)
docker-compose up -d

# Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 2: FastAPI
python3.11 main.py

# Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 3: Worker
python3.11 -m app.workers.moderation_worker

# Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 4: DLQ Monitor (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
python3.11 -m app.workers.dlq_monitor
```

### Workflow

1. **ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚** `POST /async_predict` Ñ `item_id`
2. **API ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚** Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² `moderation_results` (status=`pending`)
3. **API Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚** ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Kafka Ñ‚Ð¾Ð¿Ð¸Ðº `moderation`
4. **API Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚** `task_id` ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ
5. **Ð’Ð¾Ñ€ÐºÐµÑ€ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚** ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸Ð· Kafka
6. **Ð’Ð¾Ñ€ÐºÐµÑ€ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚** Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð· Ð‘Ð”
7. **Ð’Ð¾Ñ€ÐºÐµÑ€ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚** ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ
8. **Ð’Ð¾Ñ€ÐºÐµÑ€ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚** `moderation_results` (status=`completed`)
9. **ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚** ÑÑ‚Ð°Ñ‚ÑƒÑ Ñ‡ÐµÑ€ÐµÐ· `GET /moderation_result/{task_id}`

### Retry Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼

Ð’Ð¾Ñ€ÐºÐµÑ€ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð¿Ñ€Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…:

- **ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº**: 3
- **Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸**: 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹
- **Ð¢Ð¸Ð¿Ñ‹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº:**
  - **Permanent** (Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ðµ) â†’ ÑÑ€Ð°Ð·Ñƒ Ð² DLQ
  - **Temporary** (Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ) â†’ 3 Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ â†’ DLQ

**ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:**
- ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ â†’ Permanent â†’ DLQ
- ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° â†’ Temporary â†’ 3 retry â†’ DLQ
- Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð‘Ð” â†’ Temporary â†’ 3 retry â†’ DLQ

### Dead Letter Queue (DLQ)

ÐžÑˆÐ¸Ð±Ð¾Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð¿Ð°Ð´Ð°ÑŽÑ‚ Ð² Ñ‚Ð¾Ð¿Ð¸Ðº `moderation_dlq`.

**ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ DLQ:**
```bash
# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€
python3.11 -m app.workers.dlq_monitor

# Ð˜Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· Web Console
open http://localhost:8080
```

**Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² DLQ:**
```json
{
  "original_message": {
    "item_id": 100,
    "timestamp": "2026-02-16T12:00:00Z",
    "retry_count": 3
  },
  "error": "ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°",
  "error_type": "max_retries_exceeded",
  "timestamp": "2026-02-16T12:00:20Z",
  "retry_count": 3
}
```

## Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

### Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ñ‚ÐµÑÑ‚Ð¾Ð²
```bash
pytest tests/ -v
```

### Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼Ð¾Ð´ÑƒÐ»Ñ
```bash
pytest tests/test_ads.py -v
```

### Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð°ÑÑÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²
```bash
pytest tests/test_ads.py::TestSuccessfulPredictionViolation -v
```


## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

### Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ

```bash
# ÐŸÐ¾Ð»Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
curl -X POST http://localhost:8003/predict \
  -H "Content-Type: application/json" \
  -d '{
    "seller_id": 1,
    "is_verified_seller": true,
    "item_id": 100,
    "name": "iPhone 15",
    "description": "ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½",
    "category": 1,
    "images_qty": 5
  }'

# Ð¢Ð¾Ð»ÑŒÐºÐ¾ item_id
curl -X POST http://localhost:8003/simple_predict \
  -H "Content-Type: application/json" \
  -d '{"item_id": 100}'
```

### ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ

```bash
# 1. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ
curl -X POST http://localhost:8003/async_predict \
  -H "Content-Type: application/json" \
  -d '{"item_id": 100}'

# ÐžÑ‚Ð²ÐµÑ‚: {"task_id": 1, "status": "pending", ...}

# 2. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ (polling)
curl http://localhost:8003/moderation_result/1

# ÐŸÐ¾ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ: {"status": "pending", ...}
# ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸: {"status": "completed", "is_violation": false, ...}
```

## Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð² Kafka

Ð”Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ retry Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼Ð° Ð¸ DLQ Ð±Ñ‹Ð»Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð² ÐºÐ¾Ð´ Ð²Ð¾Ñ€ÐºÐµÑ€Ð°.

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ñ

Ð’ Ñ„Ð°Ð¹Ð» `app/workers/moderation_worker.py` Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ ML-Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ:

```python
# 3. Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ
is_violation, probability = self.model_manager.predict(
    is_verified_seller=ad.seller_is_verified,
    images_qty=ad.images_qty,
    description=ad.description,
    category=ad.category
)
raise RuntimeError("ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°")  # â† Ð¡Ð¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
```

### Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²

```bash
# Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 1: FastAPI
python3.11 main.py

# Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 2: Kafka Worker
python3.11 -m app.workers.moderation_worker

# Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 3: DLQ Monitor
python3.11 -m app.workers.dlq_monitor
```

### Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹

**1. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð½Ð° Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸ÑŽ:**

```bash
curl -X POST http://localhost:8003/async_predict \
  -H "Content-Type: application/json" \
  -d '{"item_id": 100}'
```

**ÐžÑ‚Ð²ÐµÑ‚:**
```json
{"task_id":11,"status":"pending","message":"Moderation request accepted"}
```

**2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð·Ð°Ð´Ð°Ñ‡Ð¸:**

```bash
curl -X GET http://localhost:8003/moderation_result/11
```

**ÐžÑ‚Ð²ÐµÑ‚ (Ð¿Ð¾ÐºÐ° Ð²Ð¾Ñ€ÐºÐµÑ€ Ð´ÐµÐ»Ð°ÐµÑ‚ retry Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸):**
```json
{"task_id":11,"status":"pending","is_violation":null,"probability":null,"error_message":null}
```

### Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²

#### FastAPI (main.py)

![FastAPI Ð·Ð°Ð¿ÑƒÑÐº](imgs/main.png)


#### Worker (moderation_worker.py)

Ð’Ð¾Ñ€ÐºÐµÑ€ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ 3 retry Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ñ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ð¾Ð¼ 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹:

![Worker retry Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸](imgs/worker_fail.png)


#### DLQ Monitor (dlq_monitor.py)

ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Dead Letter Queue:

![DLQ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ](imgs/dlq_error.png)


### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð² Ð‘Ð”

```bash
psql -d avito_moderation -c "
  SELECT id, item_id, status, error_message 
  FROM moderation_results 
  WHERE id = 11;
"
```

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:**
```
 id | item_id | status | error_message
----+---------+--------+----------------------------------------------
 11 |     100 | failed | ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð´Ð¾ÑÑ‚Ð¸Ð³Ð½ÑƒÑ‚. ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°: ML-Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
```

## ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ°

### Kafka Web Console
```bash
# ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ
open http://localhost:8080

# Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸:
# - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ñ‚Ð¾Ð¿Ð¸ÐºÐ¾Ð² (moderation, moderation_dlq)
# - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
# - Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ð¿Ð°Ñ€Ñ‚Ð¸Ñ†Ð¸ÑÐ¼ Ð¸ consumer groups
```

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð‘Ð”
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸
psql -d avito_moderation -c "
  SELECT id, item_id, status, is_violation, probability, created_at, processed_at
  FROM moderation_results
  ORDER BY id DESC
  LIMIT 10;
"

# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ failed Ð·Ð°Ð´Ð°Ñ‡Ð¸
psql -d avito_moderation -c "
  SELECT id, item_id, status, error_message
  FROM moderation_results
  WHERE status = 'failed';
"
```
